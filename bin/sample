#!/usr/bin/env ruby

$: << File.join(File.dirname(__FILE__), "..", "lib")

require 'avs'

CLIENT_ID     = "amzn1.application-oa2-client.62d2fef790244a9c9276fc42a6314950"
CLIENT_SECRET = "6afa76a4a1082ed32b26a7f6780963aa6f8a04d0a63964afb0007cfde0270111"
REFRESH_TOKEN = "Atzr|IwEBINGAodV0ucV74csbeIXLbO_o-uoc5nnvCwLVhObNzS1w-hToPYx2TGvOok2W5xLXn2Yd2QWVlLQHonSdrA7cVHmE_MIEjZyK7AgaCt25D14Y0j-km7fQa3vtcZDh46dy-ULEGsnbLQgSNXj_g-gIHwzZFqYbY-C7ktwfaKomU2y4KoXinheCLwXhAiK_O2fmPbVdP1vX87nRKQTPinYdwp_Fv9uEMDlHgIg_43-lmg6H2GS0P0v4UxY_hSOmb70eAdbGCzdJpQ6oOIvCyog3vuOCHWLgwnNQGYWF-ln9MNLUZpWcJ1EINFUyQ4ra3HmPgjz3xDFuTnsgrDdfQPFDipIC5EXNG13ZeItdcgPkY07GzgfZI1lCylHvkpULjoexjJoh5OP7m6lH3p0cLE9IMifQUXCFmSWJuI07XBSEW7SpR77EeOMY7132JS9nTC62NGFVoJGGEm5uGJQhktCQXHV8OAEVwXXbFedArVt9Gh1ih-D5yn7UJKVso1f8sOl4XVvnnY3z_AvFwWq0QfmMHDtD"

class App < AVS::OnDeviceWake
  def intitialize *o
    super
    
    set_listener do |time=5|
      `paplay /usr/share/sounds/purple/alert.wav`
   
      `rec -d -c 1 -r 16000 -e signed -b 16 #{f='./input.wav'} trim 0 #{time}`
   
      Thread.new do
        `paplay /usr/share/sounds/purple/alert.wav`
      end
      
      f
    end
  end
end

class Text2Alexa < AVS::AppV1
  def initialize *o
    super
    
    set_listener do
      `paplay /usr/share/sounds/purple/alert.wav`
      t=gets.chomp
      puts `/home/hmi/mycroft-core/mimic/mimic -t "#{t}" -voice slt -o #{f='./input.wav'}`
      Thread.new do; `paplay /usr/share/sounds/purple/alert.wav`; end
      f
    end
    
    set_speak do |data|
      IO.popen('bash -c "mpg321 -"', 'r+') do |io|
        io.puts data
      end    
    end
  end
end

app = Text2Alexa.new(client_id: CLIENT_ID, client_secret: CLIENT_SECRET, refresh_token: REFRESH_TOKEN)

app.run


